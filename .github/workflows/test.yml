name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight

env:
  FOUNDRY_PROFILE: ci

jobs:
  smart-contract-tests:
    name: Smart Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Forge build
        run: |
          cd smart-contract-tests
          forge --version
          forge build --sizes
        id: build

      - name: Run Forge tests
        run: |
          cd smart-contract-tests
          forge test -vvv
        id: test

      - name: Run Forge coverage
        run: |
          cd smart-contract-tests
          forge coverage --report lcov
        id: coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./smart-contract-tests/lcov.info
          flags: smart-contracts
          name: smart-contract-coverage

      - name: Check coverage threshold
        run: |
          cd smart-contract-tests
          COVERAGE=$(forge coverage --report summary | grep "Total" | awk '{print $4}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage is below 80%"
            exit 1
          fi
          echo "✅ Coverage is above 80%"

  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd api-test
          pip install -r requirements.txt

      - name: Run pytest with coverage
        run: |
          cd api-test
          pytest --cov=. --cov-report=xml --cov-report=term-missing -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./api-test/coverage.xml
          flags: api
          name: api-coverage

      - name: Check API coverage threshold
        run: |
          cd api-test
          COVERAGE=$(pytest --cov=. --cov-report=term-missing | grep "TOTAL" | awk '{print $4}' | sed 's/%//')
          echo "API Coverage: $COVERAGE%"
          if [ "$COVERAGE" -lt 70 ]; then
            echo "⚠️  Coverage is below 70% (expected during initial setup)"
          fi

  mobile-tests:
    name: Mobile Tests (Maestro)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro installation
        run: maestro -v

      - name: Validate Maestro flows
        run: |
          cd mobile-tests/maestro
          for flow in *.yaml; do
            echo "Validating $flow..."
            maestro test --no-execution "$flow" || echo "⚠️  $flow validation skipped"
          done

      # Note: Actual device testing requires cloud or local emulator
      # This job validates flow syntax only
      - name: Upload test flows as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: maestro-flows
          path: mobile-tests/maestro/*.yaml

  coverage-report:
    name: Coverage Report
    needs: [smart-contract-tests, api-tests]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Download coverage reports
        uses: actions/download-artifact@v3

      - name: Comment PR with coverage
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run Solhint
        run: |
          cd smart-contract-tests
          npm install -g solhint
          solhint 'src/**/*.sol' 'test/**/*.sol' || echo "⚠️  Linting warnings found"

      - name: Check Solidity formatting
        run: |
          cd smart-contract-tests
          forge fmt --check || echo "⚠️  Formatting issues found"

      - name: Lint Python code
        run: |
          pip install flake8 black
          cd api-test
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check . || echo "⚠️  Python formatting issues found"

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run Slither
        uses: crytic/slither-action@v0.3.0
        continue-on-error: true
        with:
          target: 'smart-contract-tests/src/'
          slither-args: '--filter-paths "test|lib"'

      - name: Check for known vulnerabilities
        run: |
          cd smart-contract-tests
          forge test --match-test "test_.*[Ss]ecurity.*" || echo "No security tests found"

  integration:
    name: Integration Tests
    needs: [smart-contract-tests, api-tests]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Install Foundry
          curl -L https://foundry.paradigm.xyz | bash
          source ~/.bashrc
          foundryup
          
          # Install Python deps
          cd api-test
          pip install -r requirements.txt

      - name: Start local testnet
        run: |
          cd smart-contract-tests
          anvil --port 8545 &
          sleep 5

      - name: Deploy contracts
        run: |
          cd smart-contract-tests
          forge script script/DeployLocal.s.sol:DeployLocal --rpc-url http://localhost:8545 --broadcast

      - name: Run integration tests
        run: |
          cd smart-contract-tests
          forge test --match-contract "Integration"

  notify:
    name: Notify on Failure
    needs: [smart-contract-tests, api-tests, mobile-tests]
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'push'
    steps:
      - name: Send notification
        run: |
          echo "⚠️  Tests failed on ${{ github.ref }}"
          # Add Slack/Discord webhook here if needed
